---
title: "時系列データ分析について"
output: html_notebook
---

- 参考  
  - [現場ですぐ使える時系列データ分析～データサイエンティストのための基礎知識](https://www.amazon.co.jp/dp/B00KNRL068/ref=cm_sw_em_r_mt_dp_FWCDFb1RJQY08)


# Chapter1　時系列データのリテラシー


- 時系列データとは  
    - 対象のある側面を特定の時間間隔で観測した結果の集まり
    
    
- 時系列データとヒストグラム  
    - 時系列データでヒストグラムを作ると、時間情報は無意味であるということになる  
    - 理由  
        ヒストグラム:確率分布の形状を調べて、同一な確率分布から独立に抽出した標本か調べる  
        時系列データは抽出順＝時間情報を情報源とする
        
        
- 時系列データのモデル化  
    1. 特定の時点の値が、過去の値に依存する分布  
        - 自己回帰モデル（ARモデル）
    1. 日々分布が変化する（分散を時間依存の関数で表す）  
        - 自己回帰条件付き分散不均一モデル（ARCHモデル） 
        - GARCHモデル


# Chapter2 時系列データの観察と要約


```{r message=FALSE}
library(dplyr)
library(ggplot2)
library(knitr)

opts_chunk$set(warning=FALSE, message=FALSE)
```

```{r}
exdata <- load("演習用データ/.Rdata")
price4 <- as.data.frame(price4)
price4 %>% head()
```

```{r message=FALSE}
attach(price4)
```


#### 元データ（株価）を確認

```{r}
par(family = "HiraKakuProN-W3", mfcol=c(2, 2))
plot(x5202, type="l", main="旭硝子")
plot(x4927, type="l", main="ポーラHD")
plot(x7272, type="l", main="ヤマハ")
plot(x4502, type="l", main="武田薬品")
```


#### 投資開始時点の株価を1に揃える

```{r}
par(family = "HiraKakuProN-W3", mfcol=c(2, 2))
plot(x5202/x5202[1], type="l", main="旭硝子")
plot(x4927/x4927[1], type="l", main="ポーラHD")
plot(x7272/x7272[1], type="l", main="ヤマハ")
plot(x4502/x4502[1], type="l", main="武田薬品")
```

#### 対数差収益率

$r_t＝logP_t－logP_{t－1}$

```{r}
# ％表示
par(family = "HiraKakuProN-W3", mfcol=c(2, 2))
plot(diff(log(x5202))*100,type="l",main="板硝子",xlab="Time",ylab="x5202")
plot(diff(log(x4927))*100,type="l",main="ポーラHD",xlab="Time",ylab="x4927")
plot(diff(log(x7272))*100,type="l",main="ヤマハ",xlab="Time",ylab="x7272")
plot(diff(log(x4502))*100,type="l",main="武田薬品",xlab="Time",ylab="x4502")
```

#### 縦軸のスケールをそろえる

```{r}
par(family = "HiraKakuProN-W3", mfcol=c(2, 2))
plot(diff(log(x5202))*100,type="l",main="板硝子",xlab="Time",ylab="x5202",ylim=range(diff(log(price4$x5202))*100))
plot(diff(log(x4927))*100,type="l",main="ポーラHD",xlab="Time",ylab="x4927",ylim=range(diff(log(price4$x5202))*100))
plot(diff(log(x7272))*100,type="l",main="ヤマハ",xlab="Time",ylab="x7272",ylim=range(diff(log(price4$x5202))*100))
plot(diff(log(x4502))*100,type="l",main="武田薬品",xlab="Time",ylab="x4502",ylim=range(diff(log(price4$x5202))*100))
```

## 2-1 時系列データの分布と要約

株価や収益率などの金融データでは、同一条件のもとのデータの数を増やすことは困難
→　同一条件のもとでのデータということにする


### 平均収益率とボラティリティ(平均収益率の標準偏差)

```{r  message=FALSE}
attach(return4)
```

```{r}
# 旭硝子
mean(x5202)
sd(x5202)
```

```{r}
# ヤマハ
mean(x4927)
sd(x4927)
```

```{r}
# ポーラHD
mean(x7272)
sd(x7272)
```

```{r}
# 武田薬品
mean(x4502)
sd(x4502)
```


```{r}
par(family = "HiraKakuProN-W3", mfcol=c(2, 2))
hist(x5202, main="旭硝子", breaks = -10:20)
hist(x4927, main="ポーラHD", breaks = -10:20)
hist(x7272, main="ヤマハ", breaks = -10:20)
hist(x4502, main="武田薬品", breaks = -10:20)
```

### 相関関係を確認


```{r}
par(family = "HiraKakuProN-W3")
plot(x = x7272, y = x4502, xlab="ヤマハ", ylab="武田薬品", main="収益率の散布図")
```

```{r}
cor(return4$x7272, return4$x4502)
```

散布図行列

```{r}
plot(return4)
```

相関係数行列

```{r}
cor(return4)
```


```{r message=FALSE}
detach(return4)
```



## 2-3 統計的仮説検定について

データ分析の前提条件
- データが正規分布に従う
- データが独立な標本である


#### ShapiroWilkの検定

データが正規分布に従っているかの検定

```{r}
# 旭硝子
shapiro.test(return4$x5202) # 有意水準10%のとき棄却
# ヤマハ
shapiro.test(return4$x7272)
# ポーラHD
shapiro.test(return4$x4927)
# 武田薬品
shapiro.test(return4$x4502)
```

#### 連の検定（runstest）

2値のデータの並びについて規則性の有無を確かめる（独立かどうかを調べる）検定

```{r message=FALSE}
library(tseries) # runs.testのライブラリ
```

```{r}
# ２値データに変換
# 旭硝子
tmp <- as.factor(return4$x5202 < mean(return4$x5202))
runs.test(tmp)

# ヤマハ
tmp <- as.factor(return4$x7272 < mean(return4$x7272))
runs.test(tmp)

# ポーラHD
tmp <- as.factor(return4$x4927 < mean(return4$x4927)) # 有意水準10%で独立ではない
runs.test(tmp)

# 武田薬品
tmp <- as.factor(return4$x4502 < mean(return4$x4502))
runs.test(tmp)
```

